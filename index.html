<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chat Fiction â€“ WhatsApp Style</title>
<meta name="theme-color" content="#075E54" />
<style>
  :root{
    --wa-green:#075E54;      /* header */
    --wa-accent:#25D366;     /* action */
    --wa-bg:#0b141a;         /* app bg */
    --wa-panel:#111b21;      /* panels */
    --wa-panel-2:#0a1014;    /* secondary */
    --wa-text:#e9edef;       /* text */
    --wa-muted:#8696a0;      /* muted */
    --bubble-in:#202c33;     /* incoming */
    --bubble-out:#005c4b;    /* outgoing */
    --line:#1f2c33;          /* borders */
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--wa-bg);color:var(--wa-text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;display:flex;min-height:100vh}

  /* Layout */
  .app{display:grid;grid-template-columns:310px 1fr;gap:0;flex:1;max-width:1400px;margin:0 auto;width:100%}
  @media (max-width: 860px){.app{grid-template-columns:1fr}.sidebar{display:none}.sidebar.open{display:block;position:fixed;z-index:30;inset:0;background:#0008}.sidebar .sheet{max-width:88%;height:100%;}}

  /* Sidebar */
  .sidebar{background:var(--wa-panel-2);border-right:1px solid var(--line)}
  .sheet{height:100%;display:flex;flex-direction:column}
  .sidehead{background:var(--wa-green);padding:14px 12px;font-weight:700;display:flex;align-items:center;gap:8px}
  .sidehead .mini-btn{background:#08493f;border:0;color:var(--wa-text);font-size:14px;padding:6px 8px;border-radius:8px}
  .folders{padding:8px;border-bottom:1px solid var(--line);display:flex;gap:8px}
  .folders select{flex:1;background:#0b141a;border:1px solid var(--line);color:var(--wa-text);border-radius:10px;padding:8px}
  .folder-actions{display:flex;gap:8px;padding:8px}
  .folder-actions button{background:#0f1a20;color:var(--wa-text);border:1px solid var(--line);padding:8px 10px;border-radius:10px;font-weight:600}
  .search{padding:8px}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b141a;color:var(--wa-text)}
  .chatlist{overflow:auto;flex:1}
  .chatrow{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .chatrow:hover{background:#0d171e}
  .chatrow img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .chatrow .meta{flex:1;min-width:0}
  .chatrow .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chatrow .last{font-size:12px;color:var(--wa-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .newchat{margin:8px;border:0;background:var(--wa-accent);color:#062a1f;font-weight:800;border-radius:10px;padding:10px 12px}

  /* Chat area */
  .main{display:flex;flex-direction:column;height:100vh}
  .head{display:flex;align-items:center;gap:10px;background:var(--wa-green);padding:10px 12px;border-left:1px solid #0003}
  .head img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .head .title{font-weight:800}
  .head .sp{flex:1}
  .head .iconbtn{background:transparent;border:0;color:#d6f5e7;font-size:16px;padding:8px 10px;border-radius:10px}

  .chat{flex:1;overflow:auto;background:url('data:image/svg+xml;utf8,\
  <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300">\
  <g fill="%23131e25" opacity="0.7">\
  <circle cx="15" cy="15" r="2"/>\
  <circle cx="75" cy="60" r="2"/>\
  <circle cx="220" cy="140" r="2"/>\
  <circle cx="140" cy="260" r="2"/>\
  </g></svg>') repeat, var(--wa-panel); padding:12px; display:flex; flex-direction:column; gap:10px}

  .msg{max-width:min(78%,640px); display:flex; gap:8px; align-items:flex-end}
  .msg.you{margin-left:auto; flex-direction:row-reverse}
  .bubble{padding:10px 12px; border-radius:14px; line-height:1.35; background:var(--bubble-in)}
  .you .bubble{background:var(--bubble-out)}
  .bubble img{max-width:100%; display:block; border-radius:10px}
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .ts{font-size:11px;color:var(--wa-muted);margin:0 6px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px;background:var(--wa-panel-2);border-top:1px solid var(--line)}
  .toolbar button, .toolbar label{background:#0f1a20;color:var(--wa-text);border:1px solid var(--line);padding:10px 12px;border-radius:10px;font-weight:600}
  .toolbar input[type=file]{display:none}
  .toolbar .fill{flex:1}
  .toolbar input[type=text]{flex:1;min-width:120px;background:#0b141a;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:var(--wa-text)}

  .panel{padding:10px;background:var(--wa-panel-2);border-top:1px solid var(--line);display:none}
  .panel.open{display:block}
  .panel textarea{width:100%;height:180px;background:#0b141a;color:var(--wa-text);border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .panel .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .panel input[type=text], .panel input[type=url]{background:#0b141a;color:var(--wa-text);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .panel .small{font-size:12px;color:var(--wa-muted)}

  .hint{font-size:12px;color:var(--wa-muted);padding:10px}
</style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (Folders & Chats) -->
    <nav class="sidebar open" id="sidebar">
      <div class="sheet">
        <div class="sidehead">
          <button class="mini-btn" id="closeSidebar" aria-label="Close">âœ•</button>
          <div style="flex:1;text-align:center;font-weight:800">Chats</div>
          <button class="mini-btn" id="openImport" title="Import">â¤“</button>
        </div>
        <div class="folders">
          <select id="folderSelect"></select>
        </div>
        <div class="folder-actions">
          <button id="newFolder">+ Folder</button>
          <button id="renameFolder">Rename</button>
          <button id="deleteFolder">Delete</button>
        </div>
        <div class="search"><input id="search" placeholder="Search chatsâ€¦"/></div>
        <div class="chatlist" id="chatlist"></div>
        <button class="newchat" id="newChat">+ New chat</button>
        <div class="hint">Hold a chat to rename or delete. Folders let you group multiple chats per story.</div>
      </div>
    </nav>

    <!-- Main Chat Area -->
    <main class="main">
      <div class="head">
        <button class="iconbtn" id="openSidebar">â˜°</button>
        <img id="chatAvatar" src="" alt="avatar"/>
        <div class="title" id="chatTitle">No chat selected</div>
        <div class="sp"></div>
        <button class="iconbtn" id="exportBtn" title="Export current chat as singleâ€‘file HTML">â¤´ï¸Ž</button>
      </div>

      <section class="chat" id="chat"></section>

      <div class="toolbar">
        <input id="who" placeholder="Name (e.g., You)" style="max-width:160px"/>
        <input id="time" placeholder="HH:MM" style="max-width:100px"/>
        <input id="text" class="fill" placeholder="Type a messageâ€¦"/>
        <label>ðŸ“· Image<input type="file" id="imageInput" accept="image/*" /></label>
        <button id="send">Send</button>
        <label>Set avatar<input type="file" id="avatarInput" accept="image/*" /></label>
      </div>

      <!-- Import/Parse Panel -->
      <div class="panel" id="importPanel">
        <div class="hint">
          Paste your script below. <strong>Format</strong>: <code>[HH:MM] Name: message</code> (timestamps will be used exactly as written).<br/>
          Use <code>[image]</code> on its own line to insert an image placeholder (attaches to the last speaker).<br/>
          <em>Main character mapping:</em> any occurrence of the name you set below will be shown as <strong>You</strong> and rightâ€‘aligned.
        </div>
        <textarea id="script" placeholder="[21:42] Harry: Did you make it home?\n[21:43] Alice: Yeah, just got in.\n[21:45] Harry: [image]\n[21:45] Alice: Still on the busâ€¦"></textarea>
        <div class="row">
          <input id="chatName" placeholder="Chat title (e.g., Alice)"/>
          <input id="meName" placeholder="Your display name (default: You)"/>
          <input id="mainName" placeholder="Main character in script (e.g., Harry)"/>
          <button id="parse">Import</button>
          <button id="cancelImport">Close</button>
        </div>
        <div class="small">Tip: After importing, attach images for any <code>[image]</code> placeholders with the ðŸ“· button (they go to the last speaker).</div>
      </div>
    </main>
  </div>

<script>
(function(){
  /* ======= State & Storage (Folders -> Chats) ======= */
  const SKEY = 'cf_collections_v1';
  let folders = load();
  if(!folders.length){
    folders = [{id:uid(), title:'My Stories', chats:[]}];
    save();
  }
  let currentFolderId = folders[0].id;
  let currentChatId = folders[0].chats[0]?.id || null;

  function uid(){return Math.random().toString(36).slice(2,10)}
  function load(){try{return JSON.parse(localStorage.getItem(SKEY)||'[]')}catch{return []}}
  function save(){localStorage.setItem(SKEY, JSON.stringify(folders))}

  /* ======= Elements ======= */
  const $ = (id)=>document.getElementById(id);
  const folderSelect = $('folderSelect');
  const chatlist = $('chatlist');
  const chatView = $('chat');
  const chatTitle = $('chatTitle');
  const chatAvatar = $('chatAvatar');
  const who = $('who');
  const text = $('text');
  const timeIn = $('time');
  const send = $('send');
  const imgInput = $('imageInput');
  const avatarInput = $('avatarInput');
  const importPanel = $('importPanel');
  const scriptBox = $('script');
  const parseBtn = $('parse');
  const cancelImport = $('cancelImport');
  const chatName = $('chatName');
  const meName = $('meName');
  const mainName = $('mainName');

  const sidebar = document.getElementById('sidebar');
  $('openSidebar').onclick=()=>{sidebar.classList.add('open')};
  $('closeSidebar').onclick=()=>{sidebar.classList.remove('open')};
  $('search').oninput=(e)=>renderList(e.target.value.trim().toLowerCase());
  $('openImport').onclick=()=>{importPanel.classList.add('open')}
  $('exportBtn').onclick=()=>exportCurrent();

  $('newFolder').onclick=()=>{const t=prompt('New folder name','New Story'); if(t){folders.unshift({id:uid(), title:t, chats:[]}); save(); renderFolders();}};
  $('renameFolder').onclick=()=>{const f=getFolder(); if(!f) return; const t=prompt('Rename folder', f.title); if(t!==null){f.title=t||'Untitled'; save(); renderFolders();}};
  $('deleteFolder').onclick=()=>{const f=getFolder(); if(!f) return; if(!confirm('Delete this folder and all its chats?')) return; const i=folders.findIndex(x=>x.id===f.id); folders.splice(i,1); save(); if(!folders.length){folders=[{id:uid(),title:'My Stories',chats:[]}];} currentFolderId=folders[0].id; currentChatId=folders[0].chats[0]?.id||null; renderFolders(); renderList(); renderChat();};

  $('newChat').onclick=()=>addChat('New chat');

  function getFolder(){return folders.find(f=>f.id===currentFolderId)}
  function getChat(){const f=getFolder(); return f? f.chats.find(c=>c.id===currentChatId) : null}

  function addChat(title){
    const f=getFolder(); if(!f) return;
    const id=uid(); const c={id,title,avatar:'',messages:[]};
    f.chats.unshift(c); currentChatId=id; save(); renderList(); renderChat();
  }

  /* ======= Rendering ======= */
  function renderFolders(){
    folderSelect.innerHTML='';
    folders.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.title; folderSelect.append(o)});
    folderSelect.value=currentFolderId;
  }
  folderSelect.onchange=(e)=>{currentFolderId=e.target.value; currentChatId=getFolder().chats[0]?.id||null; renderList(); renderChat();}

  function renderList(filter=''){
    chatlist.innerHTML='';
    const f=getFolder(); if(!f) return;
    f.chats.filter(c=>c.title.toLowerCase().includes(filter)).forEach(c=>{
      const row=document.createElement('div'); row.className='chatrow';
      row.oncontextmenu=(e)=>{e.preventDefault(); const name=prompt('Rename chat', c.title); if(name!==null){c.title=name||'Untitled'; save(); renderList(filter); renderChat();}}
      row.ontouchstart=(e)=>{row.dataset.t0=Date.now()};
      row.ontouchend=(e)=>{ if(Date.now()-(+row.dataset.t0||0)>600){ if(confirm('Delete this chat?')){ const i=f.chats.findIndex(x=>x.id===c.id); f.chats.splice(i,1); save(); if(currentChatId===c.id){currentChatId=f.chats[0]?.id||null} renderList(filter); renderChat(); } } };
      const img=document.createElement('img'); img.src=c.avatar||placeholderAvatar(c.title);
      const meta=document.createElement('div'); meta.className='meta';
      const title=document.createElement('div'); title.className='title'; title.textContent=c.title;
      const last=document.createElement('div'); last.className='last'; last.textContent=c.messages[c.messages.length-1]?.text||'';
      meta.append(title,last); row.append(img,meta); row.onclick=()=>{currentChatId=c.id; renderChat(); sidebar.classList.remove('open')};
      chatlist.append(row);
    });
  }

  function renderChat(){
    const c=getChat();
    chatView.innerHTML='';
    if(!c){ chatTitle.textContent='No chat selected'; chatAvatar.src=''; return }
    chatTitle.textContent=c.title; chatAvatar.src=c.avatar||placeholderAvatar(c.title);
    c.messages.forEach(m=>chatView.append(renderMsg(m, c)));
    chatView.scrollTop = chatView.scrollHeight;
  }

  function renderMsg(m, chat){
    const my = (meName.value||'You').trim();
    const row=document.createElement('div'); row.className='msg'+((m.displayWho||m.who)===my || m.side==='you'?' you':'');
    const av=document.createElement('img'); av.className='avatar';
    const whoName=(m.displayWho||m.who);
    av.src = whoName===my ? (chat.avatar||placeholderAvatar(chat.title)) : (m.avatar||placeholderAvatar(whoName));
    const bubble=document.createElement('div'); bubble.className='bubble';
    if(m.type==='image'){
      const im=document.createElement('img'); im.src=m.src; im.alt=m.alt||''; bubble.append(im);
      if(m.caption){ const cap=document.createElement('div'); cap.textContent=m.caption; bubble.append(cap) }
    } else { bubble.textContent=m.text||''; }
    const ts=document.createElement('div'); ts.className='ts'; ts.textContent=m.time||'';
    row.append(av,bubble,ts); return row;
  }

  function placeholderAvatar(seed){
    const ch=(seed||'?').charCodeAt(0)%360; const color=`hsl(${ch} 60% 40%)`;
    return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' rx='12' ry='12' fill='${encodeURIComponent(color)}'/><text x='50%' y='58%' font-family='Arial' font-size='36' text-anchor='middle' fill='white'>${encodeURIComponent((seed||'?')[0]||'?')}</text></svg>`
  }

  /* ======= Message actions ======= */
  send.onclick = ()=>{
    const c=getChat(); if(!c){alert('Create or select a chat first.'); return}
    const name=(who.value||'You').trim(); const t=text.value.trim(); if(!t){return}
    const tm=(timeIn.value||new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
    const my=(meName.value||'You').trim();
    const msg={id:uid(),type:'text',who:name,displayWho: name===my? my : name, text:t, time:tm};
    if(name===my) msg.side='you';
    c.messages.push(msg); save(); chatView.append(renderMsg(msg,c)); text.value=''; timeIn.value=''; chatView.scrollTop=chatView.scrollHeight;
  }

  imgInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getChat(); if(!c){alert('Create or select a chat first.'); return}
    const name=(who.value||'You').trim(); const my=(meName.value||'You').trim();
    const data=await fileToDataURL(file);
    const tm=(timeIn.value||new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
    const msg={id:uid(),type:'image',who:name,displayWho: name===my? my : name,src:data,time:tm};
    if(name===my) msg.side='you';
    c.messages.push(msg); save(); chatView.append(renderMsg(msg,c)); chatView.scrollTop=chatView.scrollHeight; e.target.value=''; timeIn.value='';
  }

  avatarInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getChat(); if(!c){alert('Create or select a chat first.'); return}
    c.avatar=await fileToDataURL(file); save(); renderChat(); e.target.value='';
  }

  function fileToDataURL(file){return new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file)})}

  /* ======= Import panel & parser ======= */
  $('cancelImport').onclick=()=>{importPanel.classList.remove('open')}
  $('parse').onclick=()=>{
    const t=scriptBox.value.replace(/\r/g,''); if(!t.trim()){alert('Paste a script first.'); return}
    const title=(chatName.value||'New chat').trim();
    const me=(meName.value||'You').trim();
    const main=(mainName.value||'Harry').trim();
    const lines=t.split('\n');
    const msgs=[]; let lastSpeaker=me; let lastTime='';
    for(const raw of lines){
      const line=raw.trim(); if(!line) continue;
      if(line.toLowerCase()==='[image]'){
        msgs.push({id:uid(),type:'image',who:lastSpeaker,displayWho: mapName(lastSpeaker, me, main), src:'',alt:'',__needsImage:true,time:lastTime});
        continue;
      }
      const m=line.match(/^\[(.*?)\]\s+([^:]{1,40}):\s*(.*)$/);
      if(m){
        const tm=m[1].trim(); const who=m[2].trim(); const msg=m[3]; lastSpeaker=who; lastTime=tm;
        msgs.push({id:uid(),type:'text',who,displayWho: mapName(who, me, main), text:msg, time:tm});
      } else {
        const prev=msgs[msgs.length-1]; if(prev && prev.type==='text'){ prev.text += (prev.text? '\n':'') + raw }
      }
    }
    msgs.forEach(m=>{ if((m.displayWho||m.who)===me) m.side='you' });
    const id=uid();
    const chat={id,title,avatar:'',messages:msgs};
    const f=getFolder(); f.chats.unshift(chat); currentChatId=id; save(); renderList(); renderChat(); importPanel.classList.remove('open');
    alert('Imported. Attach images to any [image] rows with the ðŸ“· button. Timestamps reflect your script.');
  }

  function mapName(name, me, main){ return name===main ? me : name }

  function exportCurrent(){
    const c=getChat(); if(!c){alert('Open a chat first.'); return}
    const html = buildExportHTML(c);
    const blob = new Blob([html], {type:'text/html'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = (c.title||'chat').replace(/\s+/g,'_') + '.html'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }

  function buildExportHTML(c){
    const safe = (s)=>String(s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
    const my=(meName.value||'You').trim();
    const items = c.messages.map(m=>{
      const you = (m.displayWho||m.who)===my || m.side==='you';
      if(m.type==='image'){
        return `<div class="msg${you?' you':''}"><div class="bubble"><img src="${m.src}" alt="${safe(m.alt)}"/></div><div class="ts">${safe(m.time)}</div></div>`
      }
      return `<div class="msg${you?' you':''}"><div class="bubble">${safe(m.text)}</div><div class="ts">${safe(m.time)}</div></div>`
    }).join('');
    return `<!doctype html><html><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/>`+
    `<title>${safe(c.title||'Chat')}</title><style>body{margin:0;background:#111b21;color:#e9edef;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}`+
    `.wrap{max-width:760px;margin:0 auto;padding:16px;background:#0b141a;min-height:100vh}`+
    `.msg{max-width:78%;display:flex;gap:8px;margin:8px 0}.msg.you{margin-left:auto;flex-direction:row-reverse}`+
    `.bubble{background:#202c33;border-radius:14px;padding:10px 12px;line-height:1.35}.msg.you .bubble{background:#005c4b}`+
    `.ts{font-size:11px;color:#8696a0;margin:0 6px}`+
    `</style></head><body><div class='wrap'><h2>${safe(c.title||'Chat')}</h2>${items}</div></body></html>`
  }

  /* ======= Init ======= */
  function init(){
    renderFolders();
    if(!getFolder().chats.length){ addChat('Demo chat'); }
    meName.value = 'You';
    who.value = 'You';
    renderList(); renderChat();
  }
  init();
})();
</script>
</body>
</html>
