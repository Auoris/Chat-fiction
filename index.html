<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chat Fiction â€“ WhatsApp Style</title>
<meta name="theme-color" content="#075E54" />
<style>
  :root{
    --wa-green:#075E54;      /* header */
    --wa-green-dark:#054b43; /* header dark */
    --wa-accent:#25D366;     /* action */
    --wa-bg:#0b141a;         /* app bg */
    --wa-panel:#111b21;      /* panels */
    --wa-panel-2:#0a1014;    /* secondary */
    --wa-text:#e9edef;       /* text */
    --wa-muted:#8696a0;      /* muted */
    --bubble-in:#202c33;     /* incoming */
    --bubble-out:#005c4b;    /* outgoing */
    --line:#1f2c33;          /* borders */
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--wa-bg);color:var(--wa-text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;display:flex;min-height:100vh}

  /* Layout */
  .app{display:grid;grid-template-columns:300px 1fr;gap:0;flex:1;max-width:1200px;margin:0 auto;width:100%}
  @media (max-width: 860px){.app{grid-template-columns:1fr}.sidebar{display:none}.sidebar.open{display:block;position:fixed;z-index:30;inset:0;background:#0008}.sidebar .sheet{max-width:88%;height:100%;}}

  /* Sidebar */
  .sidebar{background:var(--wa-panel-2);border-right:1px solid var(--line)}
  .sheet{height:100%;display:flex;flex-direction:column}
  .sidehead{background:var(--wa-green);padding:14px 12px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
  .sidehead .mini-btn{background:transparent;border:0;color:var(--wa-text);font-size:14px;padding:6px 8px;border-radius:8px}
  .search{padding:8px}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b141a;color:var(--wa-text)}
  .chatlist{overflow:auto;flex:1}
  .chatrow{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
  .chatrow:hover{background:#0d171e}
  .chatrow img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .chatrow .meta{flex:1;min-width:0}
  .chatrow .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chatrow .last{font-size:12px;color:var(--wa-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .newchat{margin:8px;border:0;background:var(--wa-accent);color:#062a1f;font-weight:800;border-radius:10px;padding:10px 12px}

  /* Chat area */
  .main{display:flex;flex-direction:column;height:100vh}
  .head{display:flex;align-items:center;gap:10px;background:var(--wa-green);padding:10px 12px;border-left:1px solid #0003}
  .head img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .head .title{font-weight:800}
  .head .sp{flex:1}
  .head .iconbtn{background:transparent;border:0;color:#d6f5e7;font-size:16px;padding:8px 10px;border-radius:10px}

  .chat{flex:1;overflow:auto;background:url('data:image/svg+xml;utf8,\
  <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300">\
  <g fill="%23131e25" opacity="0.7">\
  <circle cx="15" cy="15" r="2"/>\
  <circle cx="75" cy="60" r="2"/>\
  <circle cx="220" cy="140" r="2"/>\
  <circle cx="140" cy="260" r="2"/>\
  </g></svg>') repeat, var(--wa-panel); padding:12px; display:flex; flex-direction:column; gap:10px}

  .msg{max-width:min(78%,640px); display:flex; gap:8px; align-items:flex-end}
  .msg.you{margin-left:auto; flex-direction:row-reverse}
  .bubble{padding:10px 12px; border-radius:14px; line-height:1.35; background:var(--bubble-in)}
  .you .bubble{background:var(--bubble-out)}
  .bubble img{max-width:100%; display:block; border-radius:10px}
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .ts{font-size:11px;color:var(--wa-muted);margin:0 6px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px;background:var(--wa-panel-2);border-top:1px solid var(--line)}
  .toolbar button, .toolbar label{background:#0f1a20;color:var(--wa-text);border:1px solid var(--line);padding:10px 12px;border-radius:10px;font-weight:600}
  .toolbar input[type=file]{display:none}
  .toolbar .fill{flex:1}
  .toolbar input[type=text]{flex:1;min-width:120px;background:#0b141a;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:var(--wa-text)}

  .panel{padding:10px;background:var(--wa-panel-2);border-top:1px solid var(--line);display:none}
  .panel.open{display:block}
  .panel textarea{width:100%;height:160px;background:#0b141a;color:var(--wa-text);border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .panel .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .panel input[type=text], .panel input[type=url]{background:#0b141a;color:var(--wa-text);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .panel .small{font-size:12px;color:var(--wa-muted)}

  .hint{font-size:12px;color:var(--wa-muted);padding:10px}
</style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (Chats) -->
    <nav class="sidebar open" id="sidebar">
      <div class="sheet">
        <div class="sidehead">Chats
          <button class="mini-btn" id="closeSidebar" aria-label="Close">âœ•</button>
        </div>
        <div class="search"><input id="search" placeholder="Search chatsâ€¦"/></div>
        <div class="chatlist" id="chatlist"></div>
        <button class="newchat" id="newChat">+ New chat</button>
        <div class="hint">Tap a chat to open it. Longâ€‘press a chat to rename or delete.</div>
      </div>
    </nav>

    <!-- Main Chat Area -->
    <main class="main">
      <div class="head">
        <button class="iconbtn" id="openSidebar">â˜°</button>
        <img id="chatAvatar" src="" alt="avatar"/>
        <div class="title" id="chatTitle">No chat selected</div>
        <div class="sp"></div>
        <button class="iconbtn" id="importBtn" title="Import script">â¤“</button>
        <button class="iconbtn" id="exportBtn" title="Export singleâ€‘file HTML">â¤´ï¸Ž</button>
      </div>

      <section class="chat" id="chat"></section>

      <div class="toolbar">
        <input id="who" placeholder="Name (e.g., You)" style="max-width:160px"/>
        <input id="text" class="fill" placeholder="Type a messageâ€¦"/>
        <label>
          ðŸ“· Image
          <input type="file" id="imageInput" accept="image/*" />
        </label>
        <button id="send">Send</button>
        <label>
          Set avatar
          <input type="file" id="avatarInput" accept="image/*" />
        </label>
      </div>

      <!-- Import/Parse Panel -->
      <div class="panel" id="importPanel">
        <div class="hint">Paste your script below. Format each line as <code>Name: message</code>. You can insert images with <code>[image]</code> on its own line, then attach images in order after importing.</div>
        <textarea id="script" placeholder="Alice: Hey, did you make it home?\nBob: Yeah, just got in.\n[image]\nAlice: Still on the busâ€¦"></textarea>
        <div class="row">
          <input id="chatName" placeholder="Chat title (e.g., Alice)"/>
          <input id="meName" placeholder="Your name (align right, e.g., You)"/>
          <button id="parse">Import</button>
          <button id="cancelImport">Close</button>
        </div>
        <div class="small">Tip: After importing, tap ðŸ“· to attach images for any <code>[image]</code> placeholders (theyâ€™ll attach to the last speaker).</div>
      </div>
    </main>
  </div>

<script>
(function(){
  /* ======= State & Storage ======= */
  const SKEY = 'cf_chats_v1';
  let chats = load();
  let currentId = chats[0]?.id || null;

  function uid(){return Math.random().toString(36).slice(2,10)}
  function load(){try{return JSON.parse(localStorage.getItem(SKEY)||'[]')}catch{return []}}
  function save(){localStorage.setItem(SKEY, JSON.stringify(chats))}

  /* ======= Elements ======= */
  const el = (id)=>document.getElementById(id);
  const chatlist = el('chatlist');
  const chatView = el('chat');
  const chatTitle = el('chatTitle');
  const chatAvatar = el('chatAvatar');
  const who = el('who');
  const text = el('text');
  const send = el('send');
  const imgInput = el('imageInput');
  const avatarInput = el('avatarInput');
  const importBtn = el('importBtn');
  const exportBtn = el('exportBtn');
  const importPanel = el('importPanel');
  const scriptBox = el('script');
  const parseBtn = el('parse');
  const cancelImport = el('cancelImport');
  const chatName = el('chatName');
  const meName = el('meName');

  const sidebar = document.getElementById('sidebar');
  el('openSidebar').onclick=()=>{sidebar.classList.add('open')};
  el('closeSidebar').onclick=()=>{sidebar.classList.remove('open')};
  el('search').oninput=(e)=>renderList(e.target.value.trim().toLowerCase());

  /* ======= Chat CRUD ======= */
  function addChat(title='New chat'){
    const id=uid();
    const c={id,title,avatar:'',messages:[]};
    chats.unshift(c); currentId=id; save(); renderList(); renderChat();
  }
  function getCurrent(){return chats.find(c=>c.id===currentId)||null}
  function setCurrent(id){currentId=id; renderChat(); sidebar.classList.remove('open')}
  function delChat(id){
    const i=chats.findIndex(c=>c.id===id); if(i>-1){chats.splice(i,1); save(); if(currentId===id){currentId=chats[0]?.id||null} renderList(); renderChat();}
  }

  /* ======= Rendering ======= */
  function renderList(filter=''){
    chatlist.innerHTML='';
    chats.filter(c=>c.title.toLowerCase().includes(filter)).forEach(c=>{
      const row=document.createElement('div'); row.className='chatrow';
      row.oncontextmenu=(e)=>{e.preventDefault(); const name=prompt('Rename chat', c.title); if(name!==null){c.title=name||'Untitled'; save(); renderList(filter); renderChat();}}
      row.ontouchstart=(e)=>{row.dataset.touchstart=Date.now()};
      row.ontouchend=(e)=>{ if(Date.now()-(+row.dataset.touchstart||0)>600){ const act=confirm('Delete this chat?'); if(act){delChat(c.id)} } };
      const img=document.createElement('img'); img.src=c.avatar||placeholderAvatar(c.title);
      const meta=document.createElement('div'); meta.className='meta';
      const title=document.createElement('div'); title.className='title'; title.textContent=c.title;
      const last=document.createElement('div'); last.className='last'; last.textContent=c.messages[c.messages.length-1]?.text||'';
      meta.append(title,last); row.append(img,meta); row.onclick=()=>setCurrent(c.id);
      chatlist.append(row);
    });
  }

  function renderChat(){
    const c=getCurrent();
    chatView.innerHTML='';
    if(!c){ chatTitle.textContent='No chat selected'; chatAvatar.src=''; return }
    chatTitle.textContent=c.title; chatAvatar.src=c.avatar||placeholderAvatar(c.title);
    c.messages.forEach(m=>chatView.append(renderMsg(m)));
    chatView.scrollTop = chatView.scrollHeight;
  }

  function renderMsg(m){
    const row=document.createElement('div'); row.className='msg'+(m.who===meName.value.trim()||m.side==='you'?' you':'');
    const av=document.createElement('img'); av.className='avatar'; av.src=(m.who===meName.value.trim()? (getCurrent().avatar||placeholderAvatar(getCurrent().title)) : (m.avatar||placeholderAvatar(m.who)));
    const bubble=document.createElement('div'); bubble.className='bubble';
    if(m.type==='image'){
      const im=document.createElement('img'); im.src=m.src; im.alt=m.alt||''; bubble.append(im);
      if(m.caption){ const cap=document.createElement('div'); cap.textContent=m.caption; bubble.append(cap) }
    } else {
      bubble.textContent=m.text||'';
    }
    const ts=document.createElement('div'); ts.className='ts'; ts.textContent=m.time||'';
    row.append(av,bubble,ts); return row;
  }

  function placeholderAvatar(seed){
    const ch=(seed||'?').charCodeAt(0)%360; const color=`hsl(${ch} 60% 40%)`;
    return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' rx='12' ry='12' fill='${encodeURIComponent(color)}'/><text x='50%' y='58%' font-family='Arial' font-size='36' text-anchor='middle' fill='white'>${encodeURIComponent((seed||'?')[0]||'?')}</text></svg>`
  }

  /* ======= Message actions ======= */
  send.onclick = ()=>{
    const c=getCurrent(); if(!c){alert('Create or select a chat first.'); return}
    const name=(who.value||'You').trim(); const t=text.value.trim(); if(!t){return}
    const msg={id:uid(),type:'text',who:name,text:t,time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})};
    // If name matches meName, align right
    if(name===(meName.value||'You').trim()) msg.side='you';
    c.messages.push(msg); save(); chatView.append(renderMsg(msg)); text.value=''; chatView.scrollTop=chatView.scrollHeight;
  }

  imgInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getCurrent(); if(!c){alert('Create or select a chat first.'); return}
    const name=(who.value||'You').trim();
    const data=await fileToDataURL(file);
    const msg={id:uid(),type:'image',who:name,src:data,time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})};
    if(name===(meName.value||'You').trim()) msg.side='you';
    c.messages.push(msg); save(); chatView.append(renderMsg(msg)); chatView.scrollTop=chatView.scrollHeight; e.target.value='';
  }

  avatarInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getCurrent(); if(!c){alert('Create or select a chat first.'); return}
    c.avatar=await fileToDataURL(file); save(); renderChat(); e.target.value='';
  }

  function fileToDataURL(file){return new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file)})}

  /* ======= Import panel & parser ======= */
  importBtn.onclick=()=>{importPanel.classList.add('open')}
  cancelImport.onclick=()=>{importPanel.classList.remove('open')}
  parseBtn.onclick=()=>{
    const t=scriptBox.value.replace(/\r/g,''); if(!t.trim()){alert('Paste a script first.'); return}
    const title=(chatName.value||'New chat').trim();
    const me=(meName.value||'You').trim();
    const lines=t.split('\n').filter(Boolean);
    const msgs=[]; let lastSpeaker=me;
    for(const line of lines){
      if(line.trim()==='[image]'){
        msgs.push({id:uid(),type:'image',who:lastSpeaker,src:'',alt:'',__needsImage:true,time:''});
        continue;
      }
      const m=line.match(/^([^:]{1,40}):\s*(.*)$/);
      if(m){
        const who=m[1].trim(); const msg=m[2]; lastSpeaker=who;
        msgs.push({id:uid(),type:'text',who, text:msg, time:''});
      } else {
        // Continuation line
        const prev=msgs[msgs.length-1];
        if(prev && prev.type==='text'){ prev.text += (prev.text? '\n':'') + line }
      }
    }
    const id=uid(); const c={id,title,avatar:'',messages:msgs.map(m=>{ if(!m.time) m.time=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); if(m.who===me) m.side='you'; return m; })};
    chats.unshift(c); currentId=id; save(); renderList(); renderChat(); importPanel.classList.remove('open');
    alert('Imported. Add images for any [image] placeholders using the ðŸ“· button (they attach to the last speaker you set in the Name box).');
  }

  /* ======= Export ======= */
  exportBtn.onclick=()=>{
    const html = buildExportHTML();
    const blob = new Blob([html], {type:'text/html'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    const name = (getCurrent()?.title || 'chat') + '.html';
    a.download = name.replace(/\s+/g,'_'); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }

  function buildExportHTML(){
    // Minimal self-contained HTML export with current chat rendered (images embedded)
    const c=getCurrent();
    const safe = (s)=>String(s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
    const items = !c? '' : c.messages.map(m=>{
      if(m.type==='image'){
        return `<div class="msg${m.side==='you'?' you':''}"><img class="avatar" src="${m.who===(meName.value||'You')? (c.avatar||''): ''}"/><div class="bubble">`+
               `<img src="${m.src}" alt="${safe(m.alt)}"/></div><div class="ts">${safe(m.time)}</div></div>`
      }
      return `<div class="msg${m.side==='you'?' you':''}"><div class="bubble">${safe(m.text)}</div><div class="ts">${safe(m.time)}</div></div>`
    }).join('');
    return `<!doctype html><html><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/>`+
    `<title>${safe(c?.title||'Chat')}</title><style>body{margin:0;background:#111b21;color:#e9edef;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}`+
    `.wrap{max-width:760px;margin:0 auto;padding:16px;background:#0b141a;min-height:100vh}`+
    `.msg{max-width:78%;display:flex;gap:8px;margin:8px 0}.msg.you{margin-left:auto;flex-direction:row-reverse}`+
    `.bubble{background:#202c33;border-radius:14px;padding:10px 12px;line-height:1.35}.you .bubble{background:#005c4b}`+
    `.ts{font-size:11px;color:#8696a0;margin:0 6px}.avatar{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid #0006}`+
    `</style></head><body><div class='wrap'><h2>${safe(c?.title||'Chat')}</h2>${items}</div></body></html>`
  }

  /* ======= Init ======= */
  el('newChat').onclick=()=>addChat('New chat');
  if(!chats.length){ addChat('Demo chat'); }
  meName.value = 'You';
  who.value = 'You';
  renderList(); renderChat();
})();
</script>
</body>
</html>
