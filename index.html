<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Chat Fiction – WhatsApp Style</title>
<meta name="theme-color" content="#075E54" />

<!-- PWA manifest + iOS support -->
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --wa-green:#075E54;      /* header */
    --wa-accent:#25D366;     /* action */
    --wa-bg:#0b141a;         /* app bg */
    --wa-panel:#111b21;      /* panels */
    --wa-panel-2:#0a1014;    /* secondary */
    --wa-text:#e9edef;       /* text */
    --wa-muted:#a7b3bb;      /* muted (slightly brighter) */
    --bubble-in:#202c33;     /* incoming */
    --bubble-out:#005c4b;    /* outgoing */
    --line:#1f2c33;          /* borders */
    --read:#34b7f1;          /* read ticks color */
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--wa-bg);color:var(--wa-text);
    font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;
    font-size:16px;
    display:flex;min-height:100vh
  }
  body.noscroll{overflow:hidden}

  /* Layout */
  .app{display:grid;grid-template-columns:320px 1fr;gap:0;flex:1;max-width:1400px;margin:0 auto;width:100%}

  /* Sidebar */
  .sidebar{background:var(--wa-panel-2);border-right:1px solid var(--line)}
  .sheet{height:100%;display:flex;flex-direction:column}
  .sidehead{
    background:var(--wa-green);
    padding:14px 12px;
    padding-top:calc(14px + constant(safe-area-inset-top));
    padding-top:calc(14px + env(safe-area-inset-top)); /* notch-safe */
    font-weight:700;display:flex;align-items:center;gap:8px
  }
  .sidehead .mini-btn{background:#08493f;border:0;color:var(--wa-text);font-size:14px;padding:6px 8px;border-radius:8px}
  .folders{padding:8px;border-bottom:1px solid var(--line);display:flex;gap:8px}
  .folders select{flex:1;background:#0b141a;border:1px solid var(--line);color:var(--wa-text);border-radius:10px;padding:8px}
  .folder-actions{display:flex;gap:8px;padding:8px}
  .folder-actions button{background:#0f1a20;color:var(--wa-text);border:1px solid var(--line);padding:8px 10px;border-radius:10px;font-weight:600}
  .search{padding:8px}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b141a;color:var(--wa-text)}
  .chatlist{overflow:auto;flex:1}
  .chatrow{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--line);cursor:pointer}
  .chatrow:hover{background:#0d171e}
  .chatrow.active{background:#0f1a20;border-left:3px solid var(--wa-accent)} /* highlighted current chat */
  .chatrow img{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .chatrow .meta{flex:1;min-width:0}
  .chatrow .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chatrow.active .title{font-weight:900}
  .chatrow .last{font-size:13px;color:var(--wa-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .chatrow .right{margin-left:auto;text-align:right;white-space:nowrap}
  .chatrow .right .ts{font-size:11px;color:var(--wa-muted)}
  .newchat{margin:8px;border:0;background:var(--wa-accent);color:#062a1f;font-weight:800;border-radius:10px;padding:10px 12px}

  /* Mobile sidebar */
  @media (max-width: 860px){
    .app{grid-template-columns:1fr}
    .sidebar{display:none}
    .sidebar.open{
      display:block;position:fixed;z-index:30;inset:0;background:var(--wa-panel-2);
    }
    .sidebar.open .sheet{max-width:100%;height:100%}
  }

  /* Chat area */
  .main{display:flex;flex-direction:column;height:100vh}
  .head{
    display:flex;align-items:center;gap:10px;background:var(--wa-green);
    padding:10px 12px;border-left:1px solid #0003;
    padding-top:calc(10px + constant(safe-area-inset-top));
    padding-top:calc(10px + env(safe-area-inset-top)); /* notch-safe */
  }
  .head img{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid #0006}
  .contact{display:flex;flex-direction:column;gap:2px}
  .contact .title{font-weight:900;font-size:18px;line-height:1.1}
  .contact .sub{font-size:12px;color:#d6f5e7;opacity:.9;cursor:pointer}
  .head .sp{flex:1}
  .head .iconbtn{background:transparent;border:0;color:#d6f5e7;font-size:18px;padding:8px 10px;border-radius:10px}
  .statusicons{display:flex;gap:8px;align-items:center;color:#ccecdf;opacity:.85}

  .chat{
    position:relative;  /* for texture overlay */
    flex:1;overflow:auto;
    background:
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300">\
      <g fill="%23131e25" opacity="0.35">\
      <circle cx="15" cy="15" r="2"/>\
      <circle cx="75" cy="60" r="2"/>\
      <circle cx="220" cy="140" r="2"/>\
      <circle cx="140" cy="260" r="2"/>\
      </g></svg>') repeat,
      var(--wa-panel);
    padding:12px; display:flex; flex-direction:column; gap:8px
  }
  /* subtle grain overlay */
  .chat::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    opacity:.06; /* adjust strength */
    background:
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">\
        <filter id="f"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter>\
        <rect width="100%" height="100%" filter="url(%23f)" opacity="0.4" fill="%23000"/></svg>');
    mix-blend-mode:overlay;
  }

  .msg{max-width:min(78%,640px); display:flex; gap:10px; align-items:flex-end} /* gap ↑ */
  .msg.you{margin-left:auto; flex-direction:row-reverse}
  .bubble{
    padding:12px 14px; border-radius:16px; line-height:1.4; background:var(--bubble-in); position:relative;
    font-size:15.5px;
  }
  .you .bubble{background:var(--bubble-out)}
  .msg:not(.you) .bubble::after{
    content:""; position:absolute; left:-6px; bottom:0; width:0; height:0;
    border:6px solid transparent; border-right-color:var(--bubble-in); border-left:0; border-bottom:0;
  }
  .msg.you .bubble::after{
    content:""; position:absolute; right:-6px; bottom:0; width:0; height:0;
    border:6px solid transparent; border-left-color:var(--bubble-out); border-right:0; border-bottom:0;
  }
  .bubble img{max-width:100%; display:block; border-radius:10px; cursor:zoom-in}
  .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid #0006} /* bigger chat avatars */
  .ts{font-size:12px;color:var(--wa-muted);margin:0 6px}
  .metaRow{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:4px}
  .ticks{font-size:12px;line-height:1;user-select:none}
  .ticks[data-status="sent"]::before{content:"✓";opacity:0.8}
  .ticks[data-status="delivered"]::before{content:"✓✓";opacity:0.9}
  .ticks[data-status="read"]::before{content:"✓✓";color:var(--read)}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px;background:var(--wa-panel-2);border-top:1px solid var(--line)}
  .toolbar button, .toolbar label{background:#0f1a20;color:var(--wa-text);border:1px solid var(--line);padding:10px 12px;border-radius:10px;font-weight:600}
  .toolbar input[type=file]{display:none}
  .toolbar .fill{flex:1}
  .toolbar input[type=text]{flex:1;min-width:120px;background:#0b141a;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:var(--wa-text)}

  .panel{padding:10px;background:var(--wa-panel-2);border-top:1px solid var(--line);display:none}
  .panel.open{display:block}
  .panel textarea{width:100%;height:180px;background:#0b141a;color:var(--wa-text);border:1px solid var(--line);border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .panel .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .panel input[type=text]{background:#0b141a;color:var(--wa-text);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .panel .small{font-size:12px;color:var(--wa-muted)}

  .hint{font-size:12px;color:var(--wa-muted);padding:10px}

  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:#000c;display:none;align-items:center;justify-content:center;z-index:40}
  .lightbox.open{display:flex}
  .lightbox img{max-width:92vw;max-height:88vh;border-radius:12px}
  .lightbox .cap{color:#eee;margin-top:8px;text-align:center}

  /* Typing indicator */
  .typing{display:flex;gap:6px;align-items:center;margin:6px 0}
  .dots{display:inline-flex;gap:4px;padding:8px 12px;background:var(--bubble-in);border-radius:14px}
  .dot{width:6px;height:6px;border-radius:50%;background:#cfd5d8;opacity:0.8;animation:b 1s infinite}
  .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
  @keyframes b{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-3px)}}
</style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (Folders & Chats) -->
    <nav class="sidebar" id="sidebar">
      <div class="sheet">
        <div class="sidehead">
          <button class="mini-btn" id="closeSidebar" aria-label="Close">✕</button>
          <div style="flex:1;text-align:center;font-weight:800">Chats</div>
          <button class="mini-btn" id="openImport" title="Import">⤓</button>
        </div>
        <div class="folders">
          <select id="folderSelect"></select>
        </div>
        <div class="folder-actions">
          <button id="newFolder">+ Folder</button>
          <button id="renameFolder">Rename</button>
          <button id="deleteFolder">Delete</button>
        </div>
        <div class="search"><input id="search" placeholder="Search chats…"/></div>
        <div class="chatlist" id="chatlist"></div>
        <button class="newchat" id="newChat">+ New chat</button>
        <div class="hint">Hold a chat to rename or delete. Folders let you group multiple chats per story.</div>
      </div>
    </nav>

    <!-- Main Chat Area -->
    <main class="main">
      <div class="head">
        <button class="iconbtn" id="openSidebar" title="Chat list">☰</button>
        <img id="chatAvatar" src="" alt="avatar"/>
        <div class="contact">
          <div class="title" id="chatTitle">No chat selected</div>
          <div class="sub" id="chatSubtitle" title="Click to toggle Online/Offline">Offline</div>
        </div>
        <div class="sp"></div>
        <div class="statusicons" aria-hidden="true"><span>📶</span></div>
        <button class="iconbtn" id="callBtn" title="Voice call">📞</button>
        <button class="iconbtn" id="videoBtn" title="Video call">🎥</button>
        <button class="iconbtn" id="exportBtn" title="Export current chat as single-file HTML">⤴︎</button>
      </div>

      <section class="chat" id="chat"></section>

      <div class="toolbar">
        <input id="who" placeholder="Name (e.g., You)" style="max-width:160px"/>
        <input id="time" placeholder="HH:MM" style="max-width:110px" title="Leave blank to use current time (12-hour)"/>
        <input id="text" class="fill" placeholder="Type a message…"/>
        <label>📷 Image<input type="file" id="imageInput" accept="image/*" /></label>
        <button id="send">Send</button>
        <label>My avatar<input type="file" id="avatarInput" accept="image/*" /></label>
        <label>Member avatar<input type="file" id="memberAvatarInput" accept="image/*" /></label>
        <button id="typingBtn" title="Toggle typing indicator">⋯ Typing</button>
      </div>

      <!-- Import/Parse Panel -->
      <div class="panel" id="importPanel">
        <div class="hint">
          Paste your script below. <strong>Format</strong>: <code>[HH:MM] Name: message</code> (timestamps will be used exactly as written).<br/>
          Use <code>[image]</code> on its own line to insert an image placeholder (attaches to the last speaker).<br/>
          <em>Main character mapping:</em> any occurrence of the name you set below will be shown as <strong>You</strong> and right-aligned.
        </div>
        <textarea id="script" placeholder="[21:42] Harry: Did you make it home?
[21:43] Alice: Yeah, just got in.
[21:45] Harry: [image]
[21:45] Alice: Still on the bus…"></textarea>
        <div class="row">
          <input id="chatName" placeholder="Chat title (e.g., Alice)"/>
          <input id="meName" placeholder="Your display name (default: You)"/>
          <input id="mainName" placeholder="Main character in script (e.g., Harry)"/>
          <label style="align-items:center;display:flex;gap:6px"><input type="checkbox" id="appendImport" checked/> Append to current chat</label>
          <button id="parse">Import</button>
          <button id="cancelImport">Close</button>
        </div>
        <div class="small">When “Append to current chat” is checked, the script’s messages will be added to the chat you have open. Otherwise, a new chat is created.</div>
      </div>
    </main>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
    <div>
      <img id="lightboxImg" alt=""/>
      <div class="cap" id="lightboxCap"></div>
    </div>
  </div>

<script>
(function(){
  /* ======= Config ======= */
  const TIME_12H = true; // Use 12-hour display for messages created in-app

  /* ======= State & Storage (Folders -> Chats) ======= */
  const SKEY = 'cf_collections_v1';
  let folders = load();
  if(!folders.length){
    folders = [{id:uid(), title:'My Stories', chats:[]}];
    save();
  }
  let currentFolderId = folders[0].id;
  let currentChatId = folders[0].chats[0]?.id || null;

  function uid(){return Math.random().toString(36).slice(2,10)}
  function load(){try{return JSON.parse(localStorage.getItem(SKEY)||'[]')}catch{return []}}
  function save(){localStorage.setItem(SKEY, JSON.stringify(folders))}

  /* ======= Elements ======= */
  const $ = (id)=>document.getElementById(id);
  const folderSelect = $('folderSelect');
  const chatlist = $('chatlist');
  const chatView = $('chat');
  const chatTitle = $('chatTitle');
  const chatSubtitle = $('chatSubtitle');
  const chatAvatar = $('chatAvatar');
  const who = $('who');
  const text = $('text');
  const timeIn = $('time');
  const send = $('send');
  const imgInput = $('imageInput');
  const avatarInput = $('avatarInput');
  const memberAvatarInput = $('memberAvatarInput');
  const importPanel = $('importPanel');
  const scriptBox = $('script');
  const parseBtn = $('parse');
  const cancelImport = $('cancelImport');
  const chatName = $('chatName');
  const meName = $('meName');
  const mainName = $('mainName');
  const appendImport = $('appendImport');
  const typingBtn = $('typingBtn');

  const sidebar = document.getElementById('sidebar');
  $('openSidebar').onclick=()=>{sidebar.classList.add('open'); document.body.classList.add('noscroll')};
  $('closeSidebar').onclick=()=>{sidebar.classList.remove('open'); document.body.classList.remove('noscroll')};
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ sidebar.classList.remove('open'); document.body.classList.remove('noscroll'); closeLightbox(); }});
  $('search').oninput=(e)=>renderList(e.target.value.trim().toLowerCase());
  $('openImport').onclick=()=>{importPanel.classList.add('open')}
  $('exportBtn').onclick=()=>exportCurrent();

  $('newFolder').onclick=()=>{const t=prompt('New folder name','New Story'); if(t){folders.unshift({id:uid(), title:t, chats:[]}); save(); renderFolders();}};
  $('renameFolder').onclick=()=>{const f=getFolder(); if(!f) return; const t=prompt('Rename folder', f.title); if(t!==null){f.title=t||'Untitled'; save(); renderFolders();}};
  $('deleteFolder').onclick=()=>{const f=getFolder(); if(!f) return; if(!confirm('Delete this folder and all its chats?')) return; const i=folders.findIndex(x=>x.id===f.id); folders.splice(i,1); save(); if(!folders.length){folders=[{id:uid(),title:'My Stories',chats:[]}];} currentFolderId=folders[0].id; currentChatId=folders[0].chats[0]?.id||null; renderFolders(); renderList(); renderChat();};

  $('newChat').onclick=()=>addChat('New chat');

  chatSubtitle.onclick=()=>{ // toggle Online/Offline per chat
    const c=getChat(); if(!c) return;
    c.online = !c.online; save(); updatePresence(c);
  };

  function getFolder(){return folders.find(f=>f.id===currentFolderId)}
  function getChat(){const f=getFolder(); return f? f.chats.find(c=>c.id===currentChatId) : null}

  function addChat(title){
    const f=getFolder(); if(!f) return;
    const id=uid(); const c={id,title,avatar:'',participants:{},online:true,messages:[]};
    f.chats.unshift(c); currentChatId=id; save(); renderList(); renderChat();
  }

  /* ======= Rendering ======= */
  function renderFolders(){
    folderSelect.innerHTML='';
    folders.forEach(f=>{const o=document.createElement('option'); o.value=f.id; o.textContent=f.title; folderSelect.append(o)});
    folderSelect.value=currentFolderId;
  }
  folderSelect.onchange=(e)=>{currentFolderId=e.target.value; currentChatId=getFolder().chats[0]?.id||null; renderList(); renderChat();}

  function renderList(filter=''){
    chatlist.innerHTML='';
    const f=getFolder(); if(!f) return;
    f.chats
      .filter(c=>c.title.toLowerCase().includes(filter) || (c.messages.at(-1)?.text||'').toLowerCase().includes(filter))
      .forEach(c=>{
        const row=document.createElement('div');
        row.className='chatrow' + (c.id===currentChatId ? ' active' : '');  // highlight selected
        row.oncontextmenu=(e)=>{e.preventDefault(); const name=prompt('Rename chat', c.title); if(name!==null){c.title=name||'Untitled'; save(); renderList(filter); renderChat();}}
        row.ontouchstart=(e)=>{row.dataset.t0=Date.now()};
        row.ontouchend=(e)=>{ if(Date.now()-(+row.dataset.t0||0)>600){ if(confirm('Delete this chat?')){ const i=f.chats.findIndex(x=>x.id===c.id); f.chats.splice(i,1); save(); if(currentChatId===c.id){currentChatId=f.chats[0]?.id||null} renderList(filter); renderChat(); } } };
        const img=document.createElement('img'); img.src=c.avatar||placeholderAvatar(c.title);
        const meta=document.createElement('div'); meta.className='meta';
        const title=document.createElement('div'); title.className='title'; title.textContent=c.title;
        const last=document.createElement('div'); last.className='last'; last.textContent=c.messages[c.messages.length-1]?.text||'';
        meta.append(title,last);
        const right=document.createElement('div'); right.className='right';
        const ts=document.createElement('div'); ts.className='ts';
        const lastMsg=c.messages[c.messages.length-1];
        ts.textContent = lastMsg ? displayTime(lastMsg.time||'') : '';
        right.append(ts);
        row.append(img,meta,right);
        row.onclick=()=>{currentChatId=c.id; renderChat(); renderList(filter); sidebar.classList.remove('open'); document.body.classList.remove('noscroll')};
        chatlist.append(row);
      });
  }

  function renderChat(){
    const c=getChat();
    chatView.innerHTML='';
    if(!c){ chatTitle.textContent='No chat selected'; chatAvatar.src=''; chatSubtitle.textContent='Offline'; return }
    chatTitle.textContent=c.title; chatAvatar.src=c.avatar||placeholderAvatar(c.title);
    updatePresence(c);
    c.messages.forEach(m=>chatView.append(renderMsg(m, c)));
    maybeRenderTyping();
    chatView.scrollTop = chatView.scrollHeight;
  }

  function updatePresence(c){
    if(!c){chatSubtitle.textContent='Offline'; return}
    chatSubtitle.textContent = c.online ? 'Online' : 'Offline';
    chatSubtitle.style.opacity = c.online ? '0.95' : '0.6';
  }

  function resolveAvatar(chat, name, isYou){
    if(isYou){ return chat.avatar||placeholderAvatar(chat.title); }
    return (chat.participants?.[name]?.avatar) || placeholderAvatar(name);
  }

  function renderMsg(m, chat){
    const my = (meName.value||'You').trim();
    const whoName=(m.displayWho||m.who);
    const isYou = (whoName===my) || m.side==='you';

    const row=document.createElement('div'); row.className='msg'+(isYou?' you':'');
    const av=document.createElement('img'); av.className='avatar';
    av.src = resolveAvatar(chat, whoName, isYou);

    const bubble=document.createElement('div'); bubble.className='bubble';
    if(m.type==='image'){
      const im=document.createElement('img'); im.src=m.src; im.alt=m.alt||''; im.onclick=()=>openLightbox(im.src, m.caption||''); bubble.append(im);
      if(m.caption){ const cap=document.createElement('div'); cap.textContent=m.caption; bubble.append(cap) }
    } else { bubble.textContent=m.text||''; }

    const tsWrap=document.createElement('div'); tsWrap.className='metaRow';
    const ts=document.createElement('span'); ts.className='ts';
    ts.textContent = displayTime(m.time||'');
    tsWrap.append(ts);

    if(isYou){
      const ticks=document.createElement('span'); ticks.className='ticks'; ticks.dataset.status = m.status||'';
      tsWrap.append(ticks);
    }

    row.append(av,bubble,tsWrap);
    return row;
  }

  function placeholderAvatar(seed){
    const ch=(seed||'?').charCodeAt(0)%360; const color=`hsl(${ch} 60% 40%)`;
    return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' rx='12' ry='12' fill='${encodeURIComponent(color)}'/><text x='50%' y='58%' font-family='Arial' font-size='36' text-anchor='middle' fill='white'>${encodeURIComponent((seed||'?')[0]||'?')}</text></svg>`
  }

  /* ======= Message actions ======= */
  send.onclick = ()=>{
    const c=getChat(); if(!c){alert('Create or select a chat first.'); return}
    const name=(who.value||'You').trim(); const t=text.value.trim(); if(!t){return}
    const tm=(timeIn.value|| nowTime());
    const my=(meName.value||'You').trim();
    const msg={id:uid(),type:'text',who:name,displayWho: name===my? my : name, text:t, time:tm};
    if(name===my) { msg.side='you'; msg.status='sent'; }
    c.messages.push(msg); save();
    chatView.append(renderMsg(msg,c));
    text.value=''; timeIn.value='';
    chatView.scrollTop=chatView.scrollHeight;
    if(msg.side==='you') simulateStatus(c, msg.id);
  }

  imgInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getChat(); if(!c){alert('Create or select a chat first.'); return}
    const name=(who.value||'You').trim(); const my=(meName.value||'You').trim();
    const data=await fileToDataURL(file);
    const tm=(timeIn.value|| nowTime());
    const msg={id:uid(),type:'image',who:name,displayWho: name===my? my : name,src:data,time:tm};
    if(name===my) { msg.side='you'; msg.status='sent'; }
    c.messages.push(msg); save();
    chatView.append(renderMsg(msg,c));
    chatView.scrollTop=chatView.scrollHeight; e.target.value=''; timeIn.value='';
    if(msg.side==='you') simulateStatus(c, msg.id);
  }

  avatarInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getChat(); if(!c){alert('Create or select a chat first.'); return}
    c.avatar=await fileToDataURL(file); save(); renderChat(); e.target.value='';
  }

  /* Per-member avatar: applies to the name in the "Name" field */
  memberAvatarInput.onchange = async (e)=>{
    const file=e.target.files[0]; if(!file){return}
    const c=getChat(); if(!c){alert('Create or select a chat first.'); e.target.value=''; return}
    const name=(who.value||'').trim(); if(!name){alert('Set the Name field to who you want to assign an avatar to.'); e.target.value=''; return}
    const data=await fileToDataURL(file);
    const my=(meName.value||'You').trim();
    if(name===my){
      c.avatar=data;
    }else{
      c.participants = c.participants||{};
      c.participants[name] = {...(c.participants[name]||{}), avatar:data};
    }
    save(); renderChat(); renderList(); e.target.value='';
  }

  typingBtn.onclick = ()=>{ typingOn = !typingOn; maybeRenderTyping(); };

  function fileToDataURL(file){return new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file)})}

  /* ======= Import panel & parser (append into current chat by default) ======= */
  $('cancelImport').onclick=()=>{importPanel.classList.remove('open')}
  $('parse').onclick=()=>{
    const t=scriptBox.value.replace(/\r/g,''); if(!t.trim()){alert('Paste a script first.'); return}
    const me=(meName.value||'You').trim();
    const main=(mainName.value||'Harry').trim();
    const lines=t.split('\n');
    const msgs=[]; let lastSpeaker=me; let lastTime='';
    for(const raw of lines){
      const line=raw.trim(); if(!line) continue;
      if(line.toLowerCase()==='[image]'){
        msgs.push({id:uid(),type:'image',who:lastSpeaker,displayWho: mapName(lastSpeaker, me, main), src:'',alt:'',__needsImage:true,time:lastTime});
        continue;
      }
      const m=line.match(/^\[(.*?)\]\s+([^:]{1,40}):\s*(.*)$/);
      if(m){
        const tm=m[1].trim(); const who=m[2].trim(); const msg=m[3]; lastSpeaker=who; lastTime=tm;
        msgs.push({id:uid(),type:'text',who,displayWho: mapName(who, me, main), text:msg, time:tm});
      } else {
        const prev=msgs[msgs.length-1]; if(prev && prev.type==='text'){ prev.text += (prev.text? '\n':'') + raw }
      }
    }
    msgs.forEach(m=>{ if((m.displayWho||m.who)===me) m.side='you' });

    let target = (appendImport.checked && getChat()) ? getChat() : null;
    if(!target){
      const title=(chatName.value||'New chat').trim();
      const id=uid();
      target={id,title,avatar:'',participants:{},online:true,messages:[]};
      const f=getFolder(); f.chats.unshift(target); currentChatId=id;
    }
    target.participants = target.participants||{};
    msgs.forEach(m=>{ const n=(m.displayWho||m.who); if(n!==me){ target.participants[n]=target.participants[n]||{} }});
    target.messages.push(...msgs);

    save(); renderList(); renderChat(); importPanel.classList.remove('open');
    alert(appendImport.checked ? 'Imported into the current chat.' : 'Imported into a new chat.');
  }

  function mapName(name, me, main){ return name===main ? me : name }

  /* ======= Export ======= */
  function exportCurrent(){
    const c=getChat(); if(!c){alert('Open a chat first.'); return}
    const html = buildExportHTML(c);
    const blob = new Blob([html], {type:'text/html'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = (c.title||'chat').replace(/\s+/g,'_') + '.html'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }
  function buildExportHTML(c){
    const safe = (s)=>String(s||'').replace(/[&<>]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
    const my=(meName.value||'You').trim();
    const items = c.messages.map(m=>{
      const you = (m.displayWho||m.who)===my || m.side==='you';
      const ts = displayTime(m.time||'');
      if(m.type==='image'){
        return `<div class="msg${you?' you':''}"><div class="bubble"><img src="${m.src}" alt="${safe(m.alt)}"/></div><div class="ts">${safe(ts)}</div></div>`
      }
      const ticks = you && m.status ? `<span class="ticks" data-status="${m.status}"></span>` : '';
      return `<div class="msg${you?' you':''}"><div class="bubble">${safe(m.text)}</div><div class="metaRow"><span class="ts">${safe(ts)}</span>${ticks}</div></div>`
    }).join('');
    return `<!doctype html><html><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width,initial-scale=1'/>`+
    `<title>${safe(c.title||'Chat')}</title><style>
      :root{--bubble-in:#202c33;--bubble-out:#005c4b;--wa-bg:#0b141a;--wa-panel:#111b21;--wa-text:#e9edef;--wa-muted:#8696a0;--read:#34b7f1}
      body{margin:0;background:#111b21;color:var(--wa-text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
      .wrap{max-width:760px;margin:0 auto;padding:16px;background:var(--wa-bg);min-height:100vh}
      .msg{max-width:78%;display:flex;gap:8px;margin:8px 0}.msg.you{margin-left:auto;flex-direction:row-reverse}
      .bubble{background:var(--bubble-in);border-radius:14px;padding:10px 12px;line-height:1.35}.msg.you .bubble{background:var(--bubble-out)}
      .ts{font-size:11px;color:var(--wa-muted);margin:0 6px}
      .metaRow{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:4px}
      .ticks[data-status="sent"]::before{content:"✓";opacity:.8}
      .ticks[data-status="delivered"]::before{content:"✓✓";opacity:.9}
      .ticks[data-status="read"]::before{content:"✓✓";color:var(--read)}
    </style></head><body><div class='wrap'><h2>${safe(c.title||'Chat')}</h2>${items}</div></body></html>`
  }

  /* ======= Typing indicator ======= */
  let typingOn=false;
  function maybeRenderTyping(){
    const old=document.getElementById('typingRow');
    if(old) old.remove();
    if(!typingOn) return;
    const row=document.createElement('div'); row.id='typingRow'; row.className='typing';
    const my=(meName.value||'You').trim();
    const currentWho=(who.value||my);
    const yourSide = (currentWho===my);
    row.classList.toggle('you', !yourSide);
    const dots=document.createElement('div'); dots.className='dots'; dots.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    row.append(dots);
    chatView.append(row);
    chatView.scrollTop=chatView.scrollHeight;
  }

  /* ======= Lightbox ======= */
  const lightbox=$('lightbox'), lightboxImg=$('lightboxImg'), lightboxCap=$('lightboxCap');
  function openLightbox(src, cap){ lightboxImg.src=src; lightboxImg.alt=cap||''; lightboxCap.textContent=cap||''; lightbox.classList.add('open'); document.body.classList.add('noscroll'); }
  function closeLightbox(){ lightbox.classList.remove('open'); document.body.classList.remove('noscroll'); lightboxImg.src=''; }
  lightbox.addEventListener('click',(e)=>{ if(e.target===lightbox) closeLightbox(); });

  /* ======= Time helpers ======= */
  function nowTime(){
    const d=new Date();
    let h=d.getHours(), m=d.getMinutes().toString().padStart(2,'0');
    const ampm = h>=12?'PM':'AM';
    h = h%12 || 12;
    return `${h}:${m} ${ampm}`;
  }
  function displayTime(raw){
    if(!raw) return '';
    if(/\b(AM|PM)\b/i.test(raw)) return raw;
    const m = raw.match(/^(\d{1,2}):(\d{2})$/);
    if(m){
      let h=parseInt(m[1],10), mm=m[2];
      if(h>=0 && h<=23){
        const ampm = h>=12?'PM':'AM';
        h = h%12 || 12;
        return `${h}:${mm} ${ampm}`;
      }
    }
    return raw;
  }

  /* ======= Read receipts (demo) ======= */
  function simulateStatus(chat, msgId){
    setTimeout(()=>{ setStatus(chat, msgId, 'delivered'); }, 600);
    setTimeout(()=>{ setStatus(chat, msgId, 'read'); }, 1200);
  }
  function setStatus(chat, msgId, status){
    const m = chat.messages.find(x=>x.id===msgId); if(!m) return;
    m.status = status; save();
    [...chatView.querySelectorAll('.ticks')].at(-1)?.setAttribute('data-status', status);
  }

  /* ======= Init ======= */
  function init(){
    renderFolders();
    if(!getFolder().chats.length){ addChat('Demo chat'); }
    meName.value = 'You';
    who.value = 'You';
    renderList(); renderChat();
  }
  init();
})();
</script>

<!-- Service Worker Registration -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js");
  });
}
</script>

</body>
</html>
